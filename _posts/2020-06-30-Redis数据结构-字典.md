---
layout:     post
title:      "Redis数据结构-链表"
subtitle:   "Redis源码学习"
date:       2020-06-30 10:00:00
author:     "Simon"
catalog: true
header-img: "img/milky-way-3.jpg"
tags:
    - Redis

---

> “Better code, better life. ”

## `Redis`数据结构--字典

字典（Dictionary）在程序语言中又被称为哈希表（Hash Table）或者映射（Map），是一种用于保存键值对的抽象数据结构。字典中的每个键都是唯一的，可以通过键查找与之关联的值，或者更新键所苦暗恋的值。

字典在`Redis`中的使用也相当广泛，`Redis`最终要的数据库就是用字典来作为底层实现的，对数据库的增删改查也都建立在对字典的操作之上。其次，哈希键的底层实现也用到了字典。

### 定义

```c++
typedef struct dictEntry {
    void *key;
    union {
        void *val;
        uint64_t u64;
        int64_t s64;
        double d;
    } v;
    struct dictEntry *next;
} dictEntry;

typedef struct dictType {
    uint64_t (*hashFunction)(const void *key);
    void *(*keyDup)(void *privdata, const void *key);
    void *(*valDup)(void *privdata, const void *obj);
    int (*keyCompare)(void *privdata, const void *key1, const void *key2);
    void (*keyDestructor)(void *privdata, void *key);
    void (*valDestructor)(void *privdata, void *obj);
} dictType;

/* This is our hash table structure. Every dictionary has two of this as we
 * implement incremental rehashing, for the old to the new table. */
typedef struct dictht {
    dictEntry **table;
    unsigned long size;
    unsigned long sizemask;
    unsigned long used;
} dictht;

typedef struct dict {
    dictType *type;
    void *privdata;
    dictht ht[2];
    long rehashidx; /* rehashing not in progress if rehashidx == -1 */
    unsigned long iterators; /* number of iterators currently running */
} dict;

/* If safe is set to 1 this is a safe iterator, that means, you can call
 * dictAdd, dictFind, and other functions against the dictionary even while
 * iterating. Otherwise it is a non safe iterator, and only dictNext()
 * should be called while iterating. */
typedef struct dictIterator {
    dict *d;
    long index;
    int table, safe;
    dictEntry *entry, *nextEntry;
    /* unsafe iterator fingerprint for misuse detection. */
    long long fingerprint;
} dictIterator;
```

上面是`redis/src/dict.h`中关于字典的一些定义。

* 其中`dictEntry`保存字典中的键值对，`key`显然为键值对中的键，而键值对的值由一个`union`保存，它可以是一个指针，也可以是一个64位的整数。最后有一个next指针，它是用来解决hash冲突的，所有hash值相同的键值对会被放在这个链表上。

* `dictType`是针对不同类型的键值对，为创建多态字典而设置的。`dictType`中有5个函数指针，分别是哈希函数、键的复制函数、值的复制函数、键的对比函数、值的对比函数。

* `dictht`是字典结构的定义。第一个元素`table`是一个数组，数组的元素是指向`dictEntry`结构的指针。`size`是哈希表大小，`sizemask`是哈希表大小掩码，总是等于**size-1**，`used`是已有的节点数目。