---
layout:     post
title:      "poll函数源码解析"
subtitle:   "\"poll函数源码解析\""
date:       2020-08-17 20:00:00
author:     "Simon"
catalog: true
header-img: "img/se-3.jpg"
tags:
   - Linux
---

> “Better code, better life. ”

## poll函数源码解析

`poll()`是Linux系统调用，跟`select`和`epoll`组成网络编程中IO多路复用处理函数三兄弟。

### 基本参数

其声明在头文件**poll.h**中，函数原型为：

```c++
int poll(struct pollfd *fds, nfds_t nfds, int timeout);
```

参数`fds`是`pollfd`结构体指针，可以指向一个结构体数组

```c++
 struct pollfd {
     int   fd;  /* file descriptor */
     short events;  /* requested events */
     short revents;  /* returned events */
 };
```

`nfds`是调用者指定`fds`数组中的项数。

`timeout`参数指定poll()在等待文件描述符准备就绪时应该阻塞的毫秒数。

### pollfd

`pollfd`的结构如上所示。

* `fd`， 字段`fd`是打开文件的文件描述符。如果`fd<0`，则忽略相应的事件字段，并且revents字段返回零(不能用于忽略文件描述符为0的情况)。
* `events`， 输入参数，一个位掩码(`bit mask`)，用来指定应用程序对文件描述符`fd`感兴趣的事件。`events`可以为0，在这种情况下`revents`只能返回`POLLHUP`,` POLLERR`, `POLLNVAL`。
* `revents`， 输入参数，返回`events`所指定的事件。或者返回`POLLHUP`,` POLLERR`, `POLLNVAL`中的一个。

#### 函数描述

`poll`并不是一个阻塞函数，因为有`timeout`参数。如果对于任何文件描述符都没有发生所请求的事件（也没有错误），则`poll`会阻塞直到其中一个事件发生或者超时。

`timeout`将四舍五入为系统时钟的粒度，内核调度延迟意味着阻塞间隔可能会少量溢出。在超时中指定负值表示无限超时。将超时指定为零会导致poll（）立即返回，即使没有准备好文件描述符也是如此。

`events`和`revents`的定义在`poll.h`中，主要有以下几种：

* `POLLIN`，存在数据可读
* 